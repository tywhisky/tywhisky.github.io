<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>How Hot Reloading with Webpack and Phoenix - Happy Coding</title><link rel=icon type=image/png href=favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Desc Text."><meta property="og:image" content="//tywhisky.github.io/"><meta property="og:url" content="//tywhisky.github.io/posts/how-hot-reloading-for-phoenix-project/"><meta property="og:site_name" content="Happy Coding"><meta property="og:title" content="How Hot Reloading with Webpack and Phoenix"><meta property="og:description" content="Desc Text."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-15T11:30:03+00:00"><meta property="article:modified_time" content="2021-10-15T11:30:03+00:00"><meta property="article:tag" content="Elixir"><meta property="article:tag" content="Phoenix"><meta property="article:tag" content="Webpack"><meta name=twitter:card content="summary"><meta name=twitter:title content="How Hot Reloading with Webpack and Phoenix"><meta name=twitter:description content="Desc Text."><link href=//tywhisky.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=//tywhisky.github.io/css/main.a87126a5d38398207e58225b2d1a9faf97f546982f44b3ffb9715a264da36c90.css><link id=darkModeStyle rel=stylesheet type=text/css href=//tywhisky.github.io/css/dark.f163b79c6de51d14a766ff9f0563053de7f06a4d1bf7b85a59608bf96e566710.css media="(prefers-color-scheme: dark)"><script type=text/javascript src=//tywhisky.github.io/js/MathJax.js></script><script type=text/x-mathjax-config>
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				displayMath: [['$$','$$'], ['\[','\]']],
				processEscapes: true,
				processEnvironments: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
				TeX: { equationNumbers: { autoNumber: "AMS" },
						 extensions: ["AMSmath.js", "AMSsymbols.js"] }
			}
		});
		</script><link rel=stylesheet href=//tywhisky.github.io/katex/katex.min.css><script defer src=//tywhisky.github.io/katex/katex.min.js></script><script defer src=//tywhisky.github.io/katex/auto-render.min.js onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script></head><body><div class=content><header><div class=main><a href=//tywhisky.github.io/>Happy Coding</a></div><nav><a href=//tywhisky.github.io/>Home</a>
<a href=//tywhisky.github.io/posts>All posts</a>
<a href=//tywhisky.github.io/about>About</a>
<a href=//tywhisky.github.io/tags>Tags</a></nav></header><main><article><div class=post-container><div class=post-content><div class=title><h1 class=title>How Hot Reloading with Webpack and Phoenix</h1><div class=meta>Posted on Oct 15, 2021</div></div><section class=body><h3 id=live-reloading-和-hot-reloading-的区别>Live Reloading 和 Hot Reloading 的区别</h3><p>Live Reloading是在浏览器进行更改后自动重新加载整个页面，使开发者不再需要切换浏览器手动点击 <code>cmd + r</code> 。在这点上 Phoenix 通过 Phoenix LiveReload 可以提供开箱即用的支持，通过 <code>mix phx.new</code> 创建的项目默认配置了 Phoenix LiveReload。</p><p>但是，Live Reloading依然存在一个缺点，在开发现在越来越高度交互的 Web 应用时，频繁的代码改动与调试，意味着频繁的重新加载整个页面，很多情况你也许只希望修改一些样式，Live Reloading会显得尤为耗时，而为了解决这个问题，Hot Reloading 显得尤为重要。</p><h3 id=注意事项>注意事项</h3><p>本文通过 React + Webpack 进行配置举例（因为自身业务），以前 React 的 Hot Reloading 是通过 <code>HMR</code> (Hot Module Replacement) 实现的，因为一些<a href=https://github.com/facebook/react/blob/f5d946da6be8d0cefd66ab3d029a55ab54ebb460/packages/react-refresh/README.md>技术原因</a>不再使用这种方法。</p><p>我们将使用 @pmmmwh/react-refresh-webpack-plugin 这个实验性的 Webpack 插件来实现，虽然这个插件在运行一段时间后，<code>webpack-dev-server</code> 最终会吃掉大量内存，但是依然可以通过合适的配置和手动刷新，使其成为一个强大的工具。</p><h3 id=npm>NPM</h3><p>首先在你的前端项目中执行，如果你是用的是 <code>yarn</code> 请自行修改命令</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-fallback data-lang=fallback><span style=display:flex><span>npm install --save-dev @pmmmwh/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>react-refresh-webpack-plugin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>webpack-dev-server react-refresh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>react-refresh-typescript
</span></span></code></pre></div><h3 id=webpack-配置>Webpack 配置</h3><p>在逻辑结构上我们将把 <code>webpack-dev-server</code> 置于 Phoenix 应用之前。使 Webpack 能够将 websocket 注入页面，以便在需要进行 Hot Reloading 时通知浏览器。为了更好地理解，我们配置 <code>webpack-dev-server</code> 启动在 4000 端口并且代理所有的请求到 4001 端口，也就是我们 Phoenix 应用运行的端口。所以现在浏览器仍然像 <code>http://localhost:4000</code> 发出请求，但是将会被透明代理到 Phoenix。</p><p>以下是 Webpack 的配置实例</p><blockquote><p>assets/webpack.config.js</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ReactRefreshPlugin</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;@pmmmwh/react-refresh-webpack-plugin&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ReactRefreshTypeScript</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;react-refresh-typescript&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>PHOENIX_TARGET</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://localhost:4001&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>env</span>, <span style=color:#a6e22e>options</span>) =&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isDevelopment</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>mode</span> <span style=color:#f92672>!==</span> <span style=color:#e6db74>&#34;production&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mode</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>mode</span>,
</span></span><span style=display:flex><span>	<span style=color:#75715e>// We use `webpack serve` for hot reloading with phoenix
</span></span></span><span style=display:flex><span>	<span style=color:#75715e>// Phoenix serves to 4001, and webpack serves to 4000
</span></span></span><span style=display:flex><span>	<span style=color:#75715e>// Developers should use 4000 for hot reload
</span></span></span><span style=display:flex><span>	<span style=color:#a6e22e>devServer</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>proxy</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// All requests that webpack doesn&#39;t handle
</span></span></span><span style=display:flex><span>		<span style=color:#75715e>// go through to the Phoenix server
</span></span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;*&#34;</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>target</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>PHOENIX_TARGET</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>secure</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>		<span style=color:#75715e>// We don&#39;t specify ws: true here because
</span></span></span><span style=display:flex><span>		<span style=color:#75715e>// webpack serve --hot requires
</span></span></span><span style=display:flex><span>		<span style=color:#75715e>// its own non-phoenix websocket
</span></span></span><span style=display:flex><span>		<span style=color:#75715e>// (ws://localhost:4000/ws) for reloading modules
</span></span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>	<span style=color:#75715e>// WS: Live reload the entire website for development
</span></span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;/phoenix/live_reload/socket/websocket&#34;</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>target</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>PHOENIX_TARGET</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>secure</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ws</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>	<span style=color:#75715e>// WS: Live view
</span></span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;/live/websocket&#34;</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>target</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>PHOENIX_TARGET</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>secure</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ws</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>	<span style=color:#75715e>// WS: For our data and presence
</span></span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;/socket/websocket&#34;</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>target</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>PHOENIX_TARGET</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>secure</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ws</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>devMiddleware</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// webpack serve copies files into memory
</span></span></span><span style=display:flex><span>		<span style=color:#75715e>// but we need it on disk to serve from
</span></span></span><span style=display:flex><span>		<span style=color:#75715e>// proxied Phoenix&#39;s :4001 server
</span></span></span><span style=display:flex><span>		<span style=color:#a6e22e>writeToDisk</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>		... <span style=color:#a6e22e>rest</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>webpack</span> <span style=color:#a6e22e>config</span>
</span></span><span style=display:flex><span>	};
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>如上所示，列出了三种不同的 websocket，第一个用于 Phoenix LiveReload，第二个用于 Phoenix LiveView，第三个用于 Phoenix Channels。你也许已经自定义了这些配置的具体说明，可以在 <code>MyAppWeb.Endpoint</code> 中查找关键字 <code>socket/3</code>。</p><p>在 <code>loader</code> 中找到 <code>ts-loader</code>（假设你已经在用 Typescript ）并添加 <code>getCustomTransformers</code> 和 <code>transpileOnly</code>（注意 <code>isDevelopment</code> 变量在前面的代码中已经声明）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>loader</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;ts-loader&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>options</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>getCustomTransformers</span><span style=color:#f92672>:</span> () =&gt; ({
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>before</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>isDevelopment</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>ReactRefreshTypeScript</span>()].<span style=color:#a6e22e>filter</span>(Boolean),
</span></span><span style=display:flex><span>		}),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>transpileOnly</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>isDevelopment</span>,
</span></span><span style=display:flex><span>		... <span style=color:#a6e22e>other</span> <span style=color:#a6e22e>ts</span><span style=color:#f92672>-</span><span style=color:#a6e22e>loader</span> <span style=color:#a6e22e>options</span>
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>},
</span></span></code></pre></div><p>然后你需要在 plugins 中添加 <code>ReactRefreshPlugin</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>plugins</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>isDevelopment</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ReactRefreshPlugin</span>(),
</span></span><span style=display:flex><span>	... <span style=color:#a6e22e>other</span> <span style=color:#a6e22e>plugins</span>
</span></span><span style=display:flex><span>].<span style=color:#a6e22e>filter</span>(Boolean)
</span></span></code></pre></div><h3 id=硬盘写入>硬盘写入</h3><p>Webpack 通过 webpack-dev-server 构建的所有内容，只会保存在内存中，如此一来 Phoenix 无法渲染我们的静态文件。</p><p>在默认的 Phoenix 配置中中，我们使用 Webpack <code> [CopyPlugin</code>](<a href=https://webpack.js.org/plugins/copy-webpack-plugin/#root>https://webpack.js.org/plugins/copy-webpack-plugin/#root</a>)将静态文件从 <code>assets/static</code> 复制到 <code>priv/static</code>。</p><p>但是使用 webpack-dev-server 的情况下，所有内容都是从内存中提供的（并且它不提供静态文件），所以我们需要启用 <code>writeToDisk</code> 选项来实际写出静态文件，以便 Phoenix 可以为它们提供服务。这就是为什么我们必须在 webpack-dev-server Webpack 配置片段中添加 <code>writeToDisk: true</code>。</p><h3 id=phoenix-配置实例>Phoenix 配置实例</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-elixir data-lang=elixir><span style=display:flex><span>config <span style=color:#e6db74>:my_app</span>, <span style=color:#a6e22e>MyAppWeb.Endpoint</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>http</span>: [<span style=color:#e6db74>port</span>: <span style=color:#ae81ff>4001</span>],
</span></span><span style=display:flex><span><span style=color:#e6db74>url</span>: [<span style=color:#e6db74>port</span>: <span style=color:#ae81ff>4000</span>],
</span></span><span style=display:flex><span><span style=color:#75715e># also change your watchers</span>
</span></span><span style=display:flex><span><span style=color:#75715e># configuration to run webpack serve:</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>watchers</span>: [
</span></span><span style=display:flex><span>	<span style=color:#e6db74>node</span>: [
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;node_modules/webpack/bin/webpack.js&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#75715e># this indicates to webpack</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># to run the webpack-dev-server</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;serve&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;--watch-options-stdin&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;--port&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#75715e># webpack serves to 4000 to enable hot reloading,</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># but proxies to 4001 for phoenix</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># to handle the request</span>
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;4000&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;--mode&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;development&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>cd</span>: <span style=color:#a6e22e>Path</span><span style=color:#f92672>.</span>expand(<span style=color:#e6db74>&#34;../assets&#34;</span>, __DIR__)
</span></span><span style=display:flex><span>	]
</span></span><span style=display:flex><span>],
</span></span><span style=display:flex><span>... other configuration
</span></span></code></pre></div><p>在 <code>dev.exs</code> 中，将 http 端口更改为 4001，然后将 url 设置为 4000。这将使 Phoenix 绑定到端口 4001，它将实际侦听请求，但生成到端口 4000 的链接，如此一来 webpack-dev-server 便能正常工作。</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=//tywhisky.github.io/tags/elixir/>Elixir</a></li><li><a href=//tywhisky.github.io/tags/phoenix/>Phoenix</a></li><li><a href=//tywhisky.github.io/tags/webpack/>Webpack</a></li></ul></nav></div></div></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="yourDisqusShortname",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by
Disqus.</a></noscript><a href=http://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer><div style=display:flex><a class=soc href=https://github.com/tywhisky rel=me title=GitHub><svg class="feather"><use href="//tywhisky.github.io/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#github"/></svg></a><a class=border></a></div><div class=footer-info>2026 Tainef | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer></div></body></html>